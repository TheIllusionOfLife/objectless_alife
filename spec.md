# 仕様書：目的関数を持たない進化的探索による構造創発 PoC

> **ドキュメント種別**: 実装仕様書（Implementation Spec）
> **位置づけ**: 初期提案書とレビューの両方を踏まえ、研究者との対話を通じて設計判断を確定させた正式な仕様書。**実装はこのドキュメントに従うこと。**
>
> **経緯**:
> 1. [`docs/legacy/project_onboarding_guide_objective_free_alife.md`](docs/legacy/project_onboarding_guide_objective_free_alife.md) — 初期提案書。研究の動機・基本戦略・最小世界モデルを提示。
> 2. [`docs/legacy/unified_review.md`](docs/legacy/unified_review.md) — 初期提案書に対するレビュー。「破綻フィルタが暗黙の目的関数になる」等の重大な懸念を指摘。
> 3. **本ドキュメント** — レビューの指摘を受けて、研究者と設計判断を一つずつ確認し、合意した仕様をまとめたもの。
>
> **主要な設計変更（初期提案からの差分）**:
> - フィルタを物理的不整合のみ（全停止＋状態単一化）に限定し、「目的関数なし」を厳守
> - 停滞・短周期ループ・再現性フィルタを除外
> - 重なり禁止＋移動失敗ルールを明確化
> - 観測空間をtotalistic（合計ベース）設計に変更。Phase 1（密度のみ）、Phase 2（状態プロファイル）、Phase 3（制御: 密度＋ステップ時計）、Phase 4（ランダムウォーク）の四条件比較実験
> - ランダム逐次更新を採用
> - 全指標の計算式を定義
> - データ保存形式をJSON + Parquetに決定

---

## 1. 研究方針

- **コアクレーム**: 目的関数なしを厳密に貫く。フィルタは物理的不整合の排除のみ。
- **アウトプット**: ALIFE会議論文。観測チャネルの豊かさが空間的協調の創発を駆動することを示す。
- **開発手法**: TDDで堅実に進める。

---

## 2. 世界モデル

| パラメータ | 値 | 備考 |
|-----------|-----|------|
| グリッドサイズ | 20×20 | トーラス（上下左右がループ） |
| エージェント数 | 30 | 固定 |
| 内部状態 | 0〜3（4値） | 各エージェントが保持 |
| シミュレーション長 | 200ステップ（デフォルト） | パラメータとして可変 |

### 2.1 衝突ルール

- **重なり禁止**: 同一セルに複数エージェントは存在できない。
- **移動失敗**: 移動先に他エージェントがいる場合、移動は失敗しその場に留まる。

### 2.2 更新順序

- **ランダム逐次更新**: 毎ステップ、エージェントをランダムな順序でシャッフルし、1体ずつ行動を実行する。
- 逐次更新のため、先に行動したエージェントの結果が後のエージェントの観測に影響する。
- **再現性**: シミュレーション用の乱数シード（`sim_seed`）をルール生成シード（`rule_seed`）と分離して管理する。`sim_seed`はシャッフル順序・初期配置の生成に使用し、メタデータに記録する。

---

## 3. 観測空間

Game of Lifeの知見に基づき、outer totalistic（合計ベース）の観測設計を採用する。方向別の個体配置ではなく、近傍全体の**統計量**を観測する。これにより回転対称性を活用し、テーブルサイズを抑えつつ表現力を確保する。

### 3.1 Phase 1: 密度ベースライン

| 入力 | 値域 | 説明 |
|------|------|------|
| 自身の内部状態 | 0〜3（4値） | |
| 近傍の占有数 | 0〜4（5値） | 上下左右4セルのうち、エージェントがいるセルの数 |

**入力空間サイズ**: 4 × 5 = **20 エントリ**

**インデックス計算**: `state * 5 + neighbor_count`

**ルール空間**: 9^20 ≈ 1.2 × 10^19

> GoLに最も近い設計。空間的結合のみで構造が創発するかを検証するベースライン。

### 3.2 Phase 2: 状態プロファイル

| 入力 | 値域 | 説明 |
|------|------|------|
| 自身の内部状態 | 0〜3（4値） | |
| 近傍の占有数 | 0〜4（5値） | |
| 近傍の支配的状態 | 0〜3, なし（5値） | 占有近傍のうち最も多い内部状態。タイブレーク: 数値が小さい方を選択。占有近傍が0の場合は「なし」。 |

**入力空間サイズ**: 4 × 5 × 5 = **100 エントリ**

**インデックス計算**: `state * 25 + neighbor_count * 5 + dominant_state`（dominant_state: 0-3, なし=4）

**ルール空間**: 9^100 ≈ 10^95

> Phase 1に近傍の状態情報を最小限追加。Phase 1との比較により「状態情報の観測は構造創発に必要か？」という問いに直接答える。

### 3.3 Phase 3: 制御条件（密度＋ステップ時計）

Phase 2との交絡要因（テーブルサイズ）を排除するための制御条件。近傍の状態情報を含まず、代わりに非情報的なステップ時計を使用することで、Phase 2と同じテーブルサイズ（100エントリ）を維持する。

| 入力 | 値域 | 説明 |
|------|------|------|
| 自身の内部状態 | 0〜3（4値） | |
| 近傍の占有数 | 0〜4（5値） | |
| ステップ時計 | 0〜4（5値） | `step_number % CLOCK_PERIOD`（CLOCK_PERIOD=5） |

**入力空間サイズ**: 4 × 5 × 5 = **100 エントリ**

**インデックス計算**: `state * 25 + neighbor_count * CLOCK_PERIOD + step_mod`

> テーブルサイズ交絡の排除。Phase 2のMI上昇が「近傍状態の観測」によるものか「テーブルが大きいだけ」かを切り分ける。制御条件のMIが0に留まることで、Phase 2の結果が観測チャネル内容に帰属されることを示す。

### 3.4 Phase 4: ランダムウォーク

観測を一切行わないベースライン。各ステップで行動を一様ランダムに選択する。

**入力空間サイズ**: **1 エントリ**（観測なし、ルールテーブルは単一エントリ）

> 最低限のベースライン。ルールテーブルに基づく行動選択自体の効果を、完全ランダム行動と比較して検証する。

### 3.5 科学的比較

四条件（Phase 1, 2, 3, 4）を同一条件（同一seed、同一フィルタ）で実行し、以下を比較する:
- 生存率の差
- 近傍相互情報量（MI）の分布差
- エビデンス階層: Phase 4 ≤ Phase 3 (Control) ≤ Phase 1 < Phase 2

統計的検定にはMann-Whitney U検定（Holm-Bonferroni補正）を使用する。MIの推定にはMiller-Madowバイアス補正を適用する。

---

## 4. 行動空間

行動は排他的（各ステップで1つだけ選択）:

| 行動ID | 行動 | 説明 |
|--------|------|------|
| 0 | 上に移動 | |
| 1 | 下に移動 | |
| 2 | 左に移動 | |
| 3 | 右に移動 | |
| 4 | 状態を0に変更 | |
| 5 | 状態を1に変更 | |
| 6 | 状態を2に変更 | |
| 7 | 状態を3に変更 | |
| 8 | 何もしない | |

**行動空間サイズ**: 9

---

## 5. ルールテーブル

- **形式**: Phase依存のルックアップテーブル。各エントリは行動ID（0〜8）。
  - Phase 1: 20エントリ
  - Phase 2: 100エントリ
  - Phase 3 (Control): 100エントリ
  - Phase 4 (Random Walk): 1エントリ
- **インデックス計算**: セクション3の各Phaseの定義に従う。
- **生成方法**: 各エントリをランダムに0〜8から一様に選択。Phase 4では単一エントリのテーブルを生成するが、実行時はルールテーブルを参照せず一様ランダムに行動を選択する。
- **ルール空間**: Phase 1: 9^20 ≈ 10^19、Phase 2/3: 9^100 ≈ 10^95、Phase 4: 9^1 = 9。
- **全エージェント共有**: 同一シミュレーション内の全エージェントは同一ルールテーブルを使用。

---

## 6. 破綻フィルタ（物理的不整合のみ）

「目的関数なし」の原則を厳守し、以下の物理的不整合のみを排除する。

### 6.1 全停止検出（連続停止）

- **条件**: Nステップ連続で、全エージェントの位置・内部状態に変化がない場合、破綻とみなす。
- **N**: パラメータ化する（デフォルト値は実験で決定）。
- **早期打ち切り**: 検出された時点でシミュレーションを中断し、計算コストを節約。
- **終了記録**: 打ち切り時は終了理由（`halt`）と終了ステップ（`terminated_at`）をメタデータに保存する。

### 6.2 状態単一化検出

- **条件**: 全30エージェントの内部状態が完全に同一になった場合、破綻とみなす。
- **判定方法**: 完全同一のみ（閾値やエントロピーは使わない）。
- **正当化**: 区別不能な系は定義上観測不可能であり、情報理論的に意味を持たない。
- **早期打ち切り**: 検出された時点でシミュレーションを中断する。
- **終了記録**: 打ち切り時は終了理由（`state_uniform`）と終了ステップ（`terminated_at`）をメタデータに保存する。

### 除外した項目（目的関数化のリスクがあるため）

- ~~位置の単一化~~ → 重なり禁止なので物理的に発生しない
- ~~短周期ループ~~ → 動的複雑性を暗黙に要求してしまう
- ~~低活動（停滞）~~ → 活動量への選好が入ってしまう
- ~~再現性なし（強フィルタ）~~ → プロトコル未定義のため後回し

### 6.3 オプション: 動的フィルタ（デフォルトOFF）

以下のフィルタは目的関数化のリスクがあるため、デフォルトでは**無効**とする。将来のablation studyのために設定フラグとして実装し、有効/無効を切り替えられるようにする。

| フィルタ | 説明 | フラグ名 |
|---------|------|---------|
| 短周期ループ | 状態系列が短い周期で反復する場合に破綻とみなす | `filter_short_period` |
| 低活動（停滞） | 行動の多様性が極端に低い場合に破綻とみなす | `filter_low_activity` |

これらのフラグが有効な場合の判定閾値・具体的アルゴリズムは、ablation study設計時に定義する。

---

## 7. 観測指標（フルセット）

選別には一切使用しない。シミュレーション後の分析専用。

### 7.1 非自明さ

| 指標 | 計算方法 |
|------|---------|
| 状態エントロピー | Shannon entropy: H = -Σ p(s) log2 p(s)。全エージェントの内部状態分布から各ステップで計算。 |
| 圧縮率 | zlib圧縮後のサイズ / 元サイズ。グリッド全体の状態をバイト列にシリアライズして計算。 |
| 予測可能性（主指標） | **正規化ハミング距離**: t時点とt+1時点の全エージェントの内部状態ベクトル間のハミング距離を、エージェント数で正規化。値域 [0,1]、0=完全予測可能（状態変化なし）、1=全エージェントが状態変更。計算コストO(N)で解釈が明快。 |
| 予測可能性（補助指標） | **ブロック集約NCD**: 単一ステップペアではなく、連続するWステップのブロック（W=10〜20）を連結してNCDを計算する。NCD(x,y) = (C(xy) - min(C(x),C(y))) / max(C(x),C(y))、Cはzlib圧縮サイズ。ブロック集約により入力サイズを確保し、zlibヘッダのオーバーヘッド問題を回避する。値域 [0,1]。 |

### 7.2 空間構造

| 指標 | 計算方法 |
|------|---------|
| 空間自己相関 | Moran's I。**占有セルのみ**を対象とする（空セルは除外）。重み行列はトーラス上の隣接セル（4近傍）で、両方が占有セルの場合のみ重み1。値域 [-1, 1]、1=完全正相関、0=ランダム。エージェント数が2未満の場合はNaN。 |
| クラスタ数 | 同一内部状態の連結成分数。**占有セルのみ**を対象とし、4近傍で連結判定。空セルは連結に含めない。 |

### 7.3 時間構造

| 指標 | 計算方法 |
|------|---------|
| 準周期性 | 状態系列の自己相関関数のピーク数。FFTで周波数成分を分析。 |
| 相転移 | 指標の時系列における急激な変化の検出。状態エントロピーの時系列微分の最大値。 |

### 7.4 役割分化

| 指標 | 計算方法 |
|------|---------|
| 行動エントロピー | 各エージェントの行動履歴のShannon entropy。全員が同じ行動分布なら役割分化なし。 |
| 行動偏り分散 | エージェント間の行動エントロピーの分散。大きければ役割が分化している。 |

### 7.5 情報伝播

| 指標 | 計算方法 |
|------|---------|
| 近傍相互情報量 | 隣接セル間の内部状態の相互情報量 I(S_i; S_j)。全隣接ペアの平均。 |

---

## 8. 実験スケール（段階的）

| フェーズ | ルール数 | 目的 |
|---------|---------|------|
| Phase 1: デバッグ | 100 | 実装の検証、バグ出し |
| Phase 2: 探索 | 1,000 | フィルタの動作確認、生存率の概算 |
| Phase 3: 本実験 | 10,000+ | 統計的に意味のある結果、複数seedで実行 |

各フェーズで複数seed（乱数シード）を使い、結果の分散を確認する。

---

## 9. データ保存

### 9.1 ルール保存（JSON）

```json
{
  "rule_id": "uuid",
  "table": [3, 0, 8, ...],
  "survived": true,
  "filter_results": {
    "halt": false,
    "state_uniform": false
  },
  "metadata": {
    "rule_seed": 42,
    "sim_seed": 123,
    "steps": 200,
    "halt_window": 10,
    "observation_phase": 1,
    "terminated_at": null,
    "termination_reason": null
  }
}
```

### 9.2 シミュレーションログ（Parquet）

| カラム | 型 | 説明 |
|--------|-----|------|
| rule_id | string | ルールUUID |
| step | int | ステップ番号 |
| agent_id | int | エージェントID |
| x | int | X座標 |
| y | int | Y座標 |
| state | int | 内部状態 |
| action | int | **意図した**行動（ルールテーブルの出力値）。移動失敗時も意図した移動方向を記録する（結果の位置は x, y カラムから判定可能）。 |

### 9.3 指標サマリ（Parquet）

| カラム | 型 | 説明 |
|--------|-----|------|
| rule_id | string | ルールUUID |
| step | int | ステップ番号 |
| state_entropy | float | 状態エントロピー |
| compression_ratio | float | 圧縮率 |
| morans_i | float | Moran's I |
| cluster_count | int | クラスタ数 |
| ... | ... | その他の指標 |

---

## 10. 可視化

- **技術**: matplotlib FuncAnimation
- **出力**: GIF / MP4
- **内容**:
  - 20×20グリッド上のエージェント配置
  - 内部状態を色で表現（4色）
  - ステップ数表示
  - 指標のリアルタイムプロット（サブプロット）
- **対象**: 生存ルールのシミュレーションを個別にアニメーション化

---

## 11. ファイル構成

```
objectless_alife/
├── src/
│   ├── __init__.py
│   ├── world.py          # World, Agent, Grid
│   ├── rules.py          # ルール生成・ルックアップテーブル
│   ├── metrics.py        # 観測指標の計算
│   ├── filters.py        # 破綻判定フィルタ
│   ├── run_search.py     # 探索パイプライン
│   ├── stats.py          # 統計的有意性検定
│   └── visualize.py      # matplotlib可視化
├── tests/
│   ├── __init__.py
│   ├── test_world.py
│   ├── test_rules.py
│   ├── test_metrics.py
│   ├── test_filters.py
│   ├── test_run_search.py
│   ├── test_stats.py
│   └── test_visualize.py
├── data/
│   ├── rules/            # 生存ルールJSON
│   └── logs/             # シミュレーションログParquet
├── output/               # アニメーション出力
├── paper/                # ALIFE会議論文（LaTeX）
│   ├── main.tex
│   ├── references.bib
│   └── figures/
├── docs/
│   ├── legacy/           # 過去の提案書・レビュー
│   ├── stage_b_results.md
│   └── stage_c_results.md
├── pyproject.toml
└── README.md
```

---

## 12. 設計判断のまとめ

| 判断項目 | 決定 | 理由 |
|---------|------|------|
| フィルタ範囲 | 全停止＋状態単一化のみ | 「目的なし」を厳密に守る |
| 衝突 | 重なり禁止、移動失敗 | 空間的制約が複雑性の源になりうる |
| 観測 | Totalistic設計。Phase 1: 密度のみ（20）、Phase 2: ＋支配的状態（100）、Phase 3: 密度＋時計（100、制御）、Phase 4: ランダムウォーク（1） | GoLの知見に基づく合計ベース設計。四条件比較で観測チャネル内容の効果を検証 |
| 行動 | 排他的（9種） | シンプルで表現力のバランスが良い |
| 更新順序 | ランダム逐次 | 競合解決が自然 |
| 停止判定 | 連続Nステップ（Nはパラメータ） | 計算効率＋柔軟性 |
| 状態単一化 | 完全同一のみ | 閾値を使わず目的関数化を回避 |
| ステップ数 | 200（可変） | 感度分析で最適値を探る |
| データ形式 | JSON + Parquet | 柔軟性＋分析性能 |
| 可視化 | matplotlib | GIF/MP4出力、実装コスト低 |
